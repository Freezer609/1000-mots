<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1000 Mots - Révision Vocabulaire</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <style>
        :root {
            --color-background: #121212;
            --color-card: #1E1E1E;
            --color-text: #E0E0E0;
            --color-primary: #BB86FC; 
            --color-secondary: #03DAC6;
            --color-correct: #4CAF50;
            --color-incorrect: #F44336;
            --color-warning: #FFEB3B;
            --color-info: #2196F3;
        }

        body {
            background-color: var(--color-background);
            color: var(--color-text);
            font-family: 'Inter', sans-serif;
        }

        .card {
            background-color: var(--color-card);
            border: 1px solid #333;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }
        
        .btn-primary {
            background-color: var(--color-primary);
            color: var(--color-background);
            font-weight: 700;
            transition: background-color 0.2s;
        }

        .btn-primary:hover {
            background-color: #A052EE; 
        }

        .btn-secondary {
            background-color: var(--color-secondary);
            color: var(--color-background);
            font-weight: 700;
            transition: background-color 0.2s;
        }

        .btn-secondary:hover {
            background-color: #00BFA5; 
        }

        .active-mode {
            border: 3px solid var(--color-secondary);
        }

        .alert-box {
            border-left: 5px solid;
        }

        .match-item {
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .match-item.word {
            background-color: #2a2a2a;
        }

        .match-item.definition {
            background-color: #3a3a3a;
        }

        .match-item:hover {
            opacity: 0.9;
        }

        .match-item.selected {
            border: 2px solid var(--color-primary);
            box-shadow: 0 0 10px var(--color-primary);
        }

        .match-item.correct {
            background-color: var(--color-correct);
            border: 2px solid var(--color-correct);
            color: #fff;
        }

        .match-item.error {
            background-color: var(--color-incorrect);
            border: 2px solid var(--color-incorrect);
            color: #fff;
        }

        .match-list {
            min-height: 400px;
        }

        .dictation-input {
            border-color: #333;
            background-color: #1E1E1E;
            color: var(--color-text);
        }

        .dictation-input:focus {
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(187, 134, 252, 0.5);
        }

        .hang-letter-btn {
            background-color: #333;
            color: var(--color-text);
            border: 1px solid #555;
            transition: background-color 0.2s, opacity 0.2s;
        }

        .hang-letter-btn:disabled {
            background-color: #555;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .hang-word-display {
            letter-spacing: 0.5rem;
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 20px;
            min-height: 40px;
            color: var(--color-secondary);
        }

        #cheatSheet {
            font-size: 0.8rem;
            color: var(--color-warning);
            margin-top: 10px;
            cursor: pointer;
        }

        #cheatSheetContent {
            background-color: #333;
            padding: 10px;
            border-radius: 5px;
            max-height: 150px;
            overflow-y: auto;
            margin-top: 5px;
        }
    </style>

    <script>
        const ADMIN_SECRET_KEY = '4dm1nK3y'; 
        
        window.unlockAdminBridge = function(key) {
            if (key === ADMIN_SECRET_KEY) {
                console.log("Clé secrète OK. Tentative de chargement du pont d'administration...");
                
                const script = document.createElement('script');
                script.src = 'admin_bridge.js';
                script.onload = () => console.log("admin_bridge.js chargé avec succès.");
                script.onerror = () => console.error("ÉCHEC : Impossible de charger admin_bridge.js. Vérifiez le chemin ou le nom.");

                document.head.appendChild(script);
                
                window.unlockAdminBridge = null; 
            } else {
                console.error("Tentative de chargement du pont admin échouée : Clé incorrecte.");
            }
        };
        console.log("'unlockAdminBridge' est maintenant disponible pour Tampermonkey.");
    </script>
</head>
<body>
    <div class="container mx-auto p-4 max-w-7xl">
        <h1 class="text-4xl font-bold text-center mb-6" style="color: var(--color-primary);">1000 Mots - Révision</h1>
        
        <div id="alertContainer" class="mb-6 hidden">
            <div id="alertBox" class="alert-box p-4 rounded-lg text-sm" role="alert" style="border-color: var(--color-warning); background-color: rgba(255, 235, 59, 0.1);">
                <p id="alertMessage" class="font-medium" style="color: var(--color-warning);"></p>
            </div>
        </div>

        <div id="chaptersContainer" class="flex flex-wrap justify-center gap-3 mb-6">
        </div>

        <div id="subcategoriesContainer" class="flex flex-wrap justify-center gap-3 mb-8">
        </div>

        <div class="flex justify-center gap-4 mb-8">
            <button id="cardModeBtn" class="btn-primary p-4 rounded-lg w-40 active-mode">Cartes</button>
            <button id="matchModeBtn" class="btn-primary p-4 rounded-lg w-40">Association</button>
            <button id="dictationModeBtn" class="btn-primary p-4 rounded-lg w-40">Dictée</button>
            <button id="scrambleModeBtn" class="btn-primary p-4 rounded-lg w-40">Brouillage</button>
            <button id="hangModeBtn" class="btn-primary p-4 rounded-lg w-40">Pendu</button>
        </div>

        <div id="mainContent">
            
            <div id="cardMode" class="mode-content">
                <div id="cardContainer" class="card p-6 rounded-lg text-center mx-auto max-w-xl min-h-[250px] flex flex-col justify-center items-center">
                    <p id="cardText" class="text-3xl font-bold mb-4">Chargement...</p>
                    <p id="cardDefinition" class="text-lg italic" style="color: var(--color-secondary); display: none;">Définition</p>
                </div>
                <div class="flex justify-center gap-4 mt-6">
                    <button id="flipCardBtn" class="btn-secondary p-3 rounded-lg w-32">Retourner</button>
                    <button id="nextCardBtn" class="btn-primary p-3 rounded-lg w-32">Suivant</button>
                </div>
            </div>

            <div id="matchMode" class="mode-content hidden">
                <div class="text-center mb-4 text-xl" style="color: var(--color-secondary);">
                    <span id="matchScore">Paires trouvées : 0 / 10</span>
                </div>
                <div class="flex justify-center gap-8">
                    <div id="matchWords" class="match-list flex flex-col gap-2 w-full max-w-sm"></div>
                    <div id="matchDefinitions" class="match-list flex flex-col gap-2 w-full max-w-sm"></div>
                </div>
                <div class="flex justify-center mt-6">
                    <button id="matchNextBtn" class="btn-primary p-3 rounded-lg w-48 hidden">Recommencer</button>
                </div>
            </div>

            <div id="dictationMode" class="mode-content hidden">
                <div class="card p-6 rounded-lg text-center mx-auto max-w-xl">
                    <p id="dictationDefinition" class="text-xl italic mb-6" style="color: var(--color-secondary);">Définition...</p>
                    <div class="flex justify-center mb-4">
                        <button id="dictationSpeakerBtn" class="p-3 mr-4 text-2xl" style="color: var(--color-primary);"><i class="fas fa-volume-up"></i></button>
                        <input type="text" id="dictationInput" class="dictation-input p-3 rounded-lg w-full max-w-sm" placeholder="Votre réponse...">
                    </div>
                    <div id="dictationFeedback" class="text-lg font-bold min-h-[30px]"></div>
                    <button id="dictationCheckBtn" class="btn-primary p-3 rounded-lg w-32 mt-4">Vérifier</button>
                    <button id="dictationNextBtn" class="btn-secondary p-3 rounded-lg w-32 mt-4 ml-2 hidden">Suivant</button>
                </div>
            </div>

            <div id="scrambleMode" class="mode-content hidden">
                <div class="card p-6 rounded-lg text-center mx-auto max-w-xl">
                    <p id="scrambleDefinition" class="text-xl italic mb-6" style="color: var(--color-secondary);">Définition...</p>
                    <div id="scrambleWordDisplay" class="text-4xl font-mono mb-6 tracking-widest text-white"></div>
                    <input type="text" id="scrambleInput" class="dictation-input p-3 rounded-lg w-full max-w-sm" placeholder="Votre réponse...">
                    <div id="scrambleFeedback" class="text-lg font-bold min-h-[30px]"></div>
                    <button id="scrambleCheckBtn" class="btn-primary p-3 rounded-lg w-32 mt-4">Vérifier</button>
                    <button id="scrambleNextBtn" class="btn-secondary p-3 rounded-lg w-32 mt-4 ml-2 hidden">Suivant</button>
                </div>
            </div>
            
            <div id="hangMode" class="mode-content hidden">
                <div class="card p-6 rounded-lg text-center mx-auto max-w-xl">
                    <p id="hangDefinition" class="text-xl italic mb-6" style="color: var(--color-secondary);">Définition...</p>
                    <div id="hangWordDisplay" class="hang-word-display mx-auto max-w-full overflow-x-auto"></div>
                    <div id="hangLivesDisplay" class="text-lg mb-4 text-red-500">Vies restantes : <span id="hangLivesCount">6</span></div>
                    <div id="hangLettersContainer" class="flex flex-wrap justify-center gap-1">
                        </div>
                    <div id="hangFeedback" class="text-lg font-bold min-h-[30px] mt-4"></div>
                    <button id="hangNextBtn" class="btn-secondary p-3 rounded-lg w-32 mt-4 hidden">Suivant</button>
                </div>
            </div>
        </div>

        <div class="mt-8">
            <h2 class="text-2xl font-bold mb-3" style="color: var(--color-primary);">Liste Complète du Vocabulaire</h2>
            <ul id="vocabularyList" class="card p-4 rounded-lg max-h-60 overflow-y-auto">
                </ul>
        </div>
    </div>

    <script src="vocab_data.js"></script>
    <script> const container = document.querySelector('.container');
        const cardMode = document.getElementById('cardMode');
        const matchMode = document.getElementById('matchMode');
        const dictationMode = document.getElementById('dictationMode');
        const scrambleMode = document.getElementById('scrambleMode');
        const hangMode = document.getElementById('hangMode');

        const cardModeBtn = document.getElementById('cardModeBtn');
        const matchModeBtn = document.getElementById('matchModeBtn');
        const dictationModeBtn = document.getElementById('dictationModeBtn');
        const scrambleModeBtn = document.getElementById('scrambleModeBtn');
        const hangModeBtn = document.getElementById('hangModeBtn');

        const cardText = document.getElementById('cardText');
        const cardDefinition = document.getElementById('cardDefinition');
        const flipCardBtn = document.getElementById('flipCardBtn');
        const nextCardBtn = document.getElementById('nextCardBtn');
        const vocabularyList = document.getElementById('vocabularyList');
        const chaptersContainer = document.getElementById('chaptersContainer');
        const subcategoriesContainer = document.getElementById('subcategoriesContainer');
        const alertContainer = document.getElementById('alertContainer');
        const alertBox = document.getElementById('alertBox');
        const alertMessage = document.getElementById('alertMessage');

        let currentMode = 'card';
        let vocab = [];
        let currentIndex = 0;
        let isFlipped = false;
        let ALL_VOCAB = {}; 
        let currentChapterKey = null;
        let currentSubcategoryKey = null;

        let matchedPairsCount = 0;
        const MATCH_COUNT = 10;
        let selectedWordItem = null;
        let selectedDefItem = null;
        const matchWords = document.getElementById('matchWords');
        const matchDefinitions = document.getElementById('matchDefinitions');
        const matchScoreSpan = document.getElementById('matchScore');
        const matchNextBtn = document.getElementById('matchNextBtn');

        let dictationInput = document.getElementById('dictationInput');
        let dictationDefinition = document.getElementById('dictationDefinition');
        let dictationCheckBtn = document.getElementById('dictationCheckBtn');
        let dictationNextBtn = document.getElementById('dictationNextBtn');
        let dictationFeedback = document.getElementById('dictationFeedback');
        let dictationSpeakerBtn = document.getElementById('dictationSpeakerBtn');
        let currentDictationWord = '';

        let scrambleDefinition = document.getElementById('scrambleDefinition');
        let scrambleWordDisplay = document.getElementById('scrambleWordDisplay');
        let scrambleInput = document.getElementById('scrambleInput');
        let scrambleCheckBtn = document.getElementById('scrambleCheckBtn');
        let scrambleNextBtn = document.getElementById('scrambleNextBtn');
        let scrambleFeedback = document.getElementById('scrambleFeedback');
        let currentScrambleWord = '';

        const hangDefinition = document.getElementById('hangDefinition');
        const hangWordDisplay = document.getElementById('hangWordDisplay');
        const hangLettersContainer = document.getElementById('hangLettersContainer');
        const hangLivesCount = document.getElementById('hangLivesCount');
        const hangFeedback = document.getElementById('hangFeedback');
        const hangNextBtn = document.getElementById('hangNextBtn');
        let hangSecretWord = '';
        let hangDisplayedWord = [];
        let hangLives = 6;
        let usedLetters = new Set();


        function setMode(mode) {
            document.querySelectorAll('.mode-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('button[id$="ModeBtn"]').forEach(el => el.classList.remove('active-mode'));
            
            document.getElementById(`${mode}Mode`).classList.remove('hidden');
            document.getElementById(`${mode}ModeBtn`).classList.add('active-mode');
            currentMode = mode;

            if (vocab.length > 0) {
                switch (mode) {
                    case 'card':
                        startCardMode();
                        break;
                    case 'match':
                        startMatchGame();
                        break;
                    case 'dictation':
                        startDictationGame(vocab);
                        break;
                    case 'scramble':
                        startScrambleGame(vocab);
                        break;
                    case 'hang':
                        startHangGame(vocab);
                        break;
                }
            } else {
                cardText.textContent = "Sélectionnez un chapitre et une sous-catégorie pour commencer.";
                cardDefinition.style.display = 'none';
            }
        }

        function generateChapterButtons() {
            chaptersContainer.innerHTML = '';
            for (const key in ALL_VOCAB_DATA) {
                const chapter = ALL_VOCAB_DATA[key];
                const button = document.createElement('button');
                button.id = chapter.selectorId;
                button.textContent = chapter.title;
                button.classList.add('btn-primary', 'p-3', 'rounded-lg', 'font-medium');
                button.addEventListener('click', () => {
                    selectChapter(key);
                });
                chaptersContainer.appendChild(button);
            }
        }

        function selectChapter(key) {
            currentChapterKey = key;
            currentSubcategoryKey = null;
            document.querySelectorAll('#chaptersContainer button').forEach(btn => btn.classList.remove('active-mode'));
            document.getElementById(ALL_VOCAB_DATA[key].selectorId).classList.add('active-mode');
            generateSubcategoryButtons(key);
            vocab = [];
            hideAlert();
        }

        function generateSubcategoryButtons(chapterKey) {
            subcategoriesContainer.innerHTML = '';
            const chapter = ALL_VOCAB_DATA[chapterKey];
            for (const key in chapter.subcategories) {
                const subcategory = chapter.subcategories[key];
                const button = document.createElement('button');
                button.textContent = subcategory.name;
                button.classList.add('btn-primary', 'p-3', 'rounded-lg', 'font-medium');
                button.style.backgroundColor = subcategory.color; 
                button.addEventListener('click', () => {
                    changeVocabulary(chapterKey, key);
                });
                subcategoriesContainer.appendChild(button);
            }
        }

        function changeVocabulary(chapterKey, subcategoryKey) {
            currentSubcategoryKey = subcategoryKey;
            document.querySelectorAll('#subcategoriesContainer button').forEach(btn => btn.classList.remove('active-mode'));
            const subcategory = ALL_VOCAB_DATA[chapterKey].subcategories[subcategoryKey];
            const buttonToActivate = Array.from(subcategoriesContainer.children).find(btn => btn.textContent === subcategory.name);
            if (buttonToActivate) {
                buttonToActivate.classList.add('active-mode');
            }

            vocab = [...subcategory.data].sort(() => 0.5 - Math.random()); 
            currentIndex = 0;
            generateList();

            if (subcategory.alert) {
                showAlert(subcategory.alert.message, subcategory.alert.color);
            } else {
                hideAlert();
            }

            setMode(currentMode); 
        }

        function showAlert(message, color) {
            alertContainer.classList.remove('hidden');
            alertMessage.textContent = message;
            alertBox.style.borderColor = color;
            alertBox.style.backgroundColor = `${color}1A`; 
            alertMessage.style.color = color;
        }

        function hideAlert() {
            alertContainer.classList.add('hidden');
        }

        cardModeBtn.addEventListener('click', () => setMode('card'));
        matchModeBtn.addEventListener('click', () => setMode('match'));
        dictationModeBtn.addEventListener('click', () => setMode('dictation'));
        scrambleModeBtn.addEventListener('click', () => setMode('scramble'));
        hangModeBtn.addEventListener('click', () => setMode('hang'));

        function startCardMode() {
            isFlipped = false;
            cardDefinition.style.display = 'none';
            displayCard();
        }

        function displayCard() {
            if (vocab.length === 0) return;
            const pair = vocab[currentIndex];
            cardText.textContent = isFlipped ? pair[1] : pair[0];
            cardDefinition.textContent = pair[1];
        }

        flipCardBtn.addEventListener('click', () => {
            isFlipped = !isFlipped;
            cardDefinition.style.display = isFlipped ? 'block' : 'none';
            cardText.textContent = isFlipped ? vocab[currentIndex][1] : vocab[currentIndex][0];
        });

        nextCardBtn.addEventListener('click', () => {
            currentIndex = (currentIndex + 1) % vocab.length;
            startCardMode();
        });

        function startDictationGame(currentVocab) {
            dictationCheckBtn.classList.remove('hidden');
            dictationNextBtn.classList.add('hidden');
            dictationInput.value = '';
            dictationFeedback.textContent = '';
            dictationInput.disabled = false;
            
            currentIndex = (currentIndex + 1) % currentVocab.length;
            const pair = currentVocab[currentIndex];
            currentDictationWord = pair[0]; 
            dictationDefinition.textContent = pair[1];

            if (window.chosenWord !== undefined) window.chosenWord = currentDictationWord; 
        }

        dictationSpeakerBtn.addEventListener('click', () => {
            if (currentDictationWord) {
                const utterance = new SpeechSynthesisUtterance(currentDictationWord);
                utterance.lang = 'fr-FR'; 
                speechSynthesis.speak(utterance);
            }
        });

        dictationCheckBtn.addEventListener('click', () => {
            const userAnswer = dictationInput.value.trim().toLowerCase();
            const correctWord = currentDictationWord.trim().toLowerCase();

            if (userAnswer === correctWord) {
                dictationFeedback.textContent = 'Correct !';
                dictationFeedback.style.color = var(--color-correct);
                dictationInput.disabled = true;
                dictationCheckBtn.classList.add('hidden');
                dictationNextBtn.classList.remove('hidden');
            } else {
                dictationFeedback.textContent = `Faux. La réponse était : ${currentDictationWord}`;
                dictationFeedback.style.color = var(--color-incorrect);
            }
        });

        dictationNextBtn.addEventListener('click', () => {
            startDictationGame(vocab);
        });

        function shuffleWord(word) {
            return word.split('').sort(() => 0.5 - Math.random()).join('');
        }

        function startScrambleGame(currentVocab) {
            scrambleCheckBtn.classList.remove('hidden');
            scrambleNextBtn.classList.add('hidden');
            scrambleInput.value = '';
            scrambleFeedback.textContent = '';
            scrambleInput.disabled = false;

            currentIndex = (currentIndex + 1) % currentVocab.length;
            const pair = currentVocab[currentIndex];
            currentScrambleWord = pair[0];
            scrambleDefinition.textContent = pair[1];
            scrambleWordDisplay.textContent = shuffleWord(currentScrambleWord);

            if (window.chosenWord !== undefined) window.chosenWord = currentScrambleWord;
        }

        scrambleCheckBtn.addEventListener('click', () => {
            const userAnswer = scrambleInput.value.trim().toLowerCase();
            const correctWord = currentScrambleWord.trim().toLowerCase();

            if (userAnswer === correctWord) {
                scrambleFeedback.textContent = 'Correct !';
                scrambleFeedback.style.color = var(--color-correct);
                scrambleInput.disabled = true;
                scrambleCheckBtn.classList.add('hidden');
                scrambleNextBtn.classList.remove('hidden');
            } else {
                scrambleFeedback.textContent = `Faux. La réponse était : ${currentScrambleWord}`;
                scrambleFeedback.style.color = var(--color-incorrect);
            }
        });

        scrambleNextBtn.addEventListener('click', () => {
            startScrambleGame(vocab);
        });

        function startHangGame(currentVocab) {
            hangNextBtn.classList.add('hidden');
            hangFeedback.textContent = '';
            hangLives = 6;
            usedLetters = new Set();
            hangLivesCount.textContent = hangLives;

            currentIndex = (currentIndex + 1) % currentVocab.length;
            const pair = currentVocab[currentIndex];
            hangSecretWord = pair[0].toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g, ""); 
            hangDefinition.textContent = pair[1];

            hangDisplayedWord = Array(hangSecretWord.length).fill('_');
            updateHangDisplay();
            generateHangButtons();
            
            if (window.chosenWord !== undefined) window.chosenWord = hangSecretWord;
        }

        function updateHangDisplay() {
            hangWordDisplay.textContent = hangDisplayedWord.join(' ');
        }

        function generateHangButtons() {
            hangLettersContainer.innerHTML = '';
            // Correction du bug : Les caractères spéciaux dans le mot secret (comme le tiret ou l'espace) sont maintenant affichés
            for (let i = 0; i < hangSecretWord.length; i++) {
                if (hangSecretWord[i] === ' ' || hangSecretWord[i] === '-') {
                    hangDisplayedWord[i] = hangSecretWord[i];
                }
            }
            updateHangDisplay();

            const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            
            // Correction du bug pour la lettre A (et toutes les autres)
            // On s'assure que le bouton n'est pas déjà dans le DOM.
            const existingButtons = Array.from(hangLettersContainer.children).map(btn => btn.textContent);
            
            for (const letter of alphabet) {
                if (!existingButtons.includes(letter)) {
                    const button = document.createElement('button');
                    button.textContent = letter;
                    button.classList.add('hang-letter-btn', 'p-2', 'rounded-md', 'w-10', 'h-10');
                    button.addEventListener('click', () => guessLetter(letter, button));
                    hangLettersContainer.appendChild(button);
                }
            }
        }

        function guessLetter(letter, button) {
            if (usedLetters.has(letter) || hangLives === 0 || !hangDisplayedWord.includes('_')) return;

            usedLetters.add(letter);
            button.disabled = true;

            let found = false;
            for (let i = 0; i < hangSecretWord.length; i++) {
                if (hangSecretWord[i] === letter) {
                    hangDisplayedWord[i] = letter;
                    found = true;
                }
            }

            if (found) {
                button.style.backgroundColor = var(--color-correct);
                updateHangDisplay();
                if (!hangDisplayedWord.includes('_')) {
                    endHangGame(true);
                }
            } else {
                hangLives--;
                hangLivesCount.textContent = hangLives;
                button.style.backgroundColor = var(--color-incorrect);
                if (hangLives === 0) {
                    endHangGame(false);
                }
            }
        }

        function endHangGame(win) {
            document.querySelectorAll('.hang-letter-btn').forEach(btn => btn.disabled = true);
            if (win) {
                hangFeedback.textContent = 'Bravo ! Vous avez trouvé le mot.';
                hangFeedback.style.color = var(--color-correct);
            } else {
                hangFeedback.textContent = `Perdu ! Le mot était : ${hangSecretWord}`;
                hangFeedback.style.color = var(--color-incorrect);
            }
            hangNextBtn.classList.remove('hidden');
        }

        hangNextBtn.addEventListener('click', () => {
            startHangGame(vocab);
        });

        function startMatchGame() {
            matchedPairsCount = 0;
            updateMatchScore();
            matchNextBtn.classList.add('hidden');
            selectedWordItem = null;
            selectedDefItem = null;
            matchWords.innerHTML = '';
            matchDefinitions.innerHTML = '';

            const shuffledVocab = [...vocab].sort(() => 0.5 - Math.random()).slice(0, MATCH_COUNT);
            const words = shuffledVocab.map(pair => pair[0]);
            const definitions = shuffledVocab.map(pair => pair[1]).sort(() => 0.5 - Math.random());

            words.forEach(word => {
                const item = createMatchItem(word, 'word');
                matchWords.appendChild(item);
            });

            definitions.forEach(def => {
                const item = createMatchItem(def, 'definition');
                matchDefinitions.appendChild(item);
            });
        }

        function createMatchItem(text, type) {
            const item = document.createElement('div');
            item.textContent = text;
            item.classList.add('match-item', type, 'p-3', 'rounded-lg');
            item.addEventListener('click', () => selectMatchItem(item, text, type));
            return item;
        }

        function selectMatchItem(item, text, type) {
            if (item.classList.contains('correct') || (type === 'word' && selectedWordItem === item) || (type === 'definition' && selectedDefItem === item)) return;

            if (type === 'word') {
                if (selectedWordItem) selectedWordItem.classList.remove('selected');
                selectedWordItem = item;
                selectedWordItem.classList.add('selected');
            } else {
                if (selectedDefItem) selectedDefItem.classList.remove('selected');
                selectedDefItem = item;
                selectedDefItem.classList.add('selected');
            }

            if (selectedWordItem && selectedDefItem) {
                checkMatch();
            }
        }

        function checkMatch() {
            const word = selectedWordItem.textContent;
            const definition = selectedDefItem.textContent;
            
            const isMatch = vocab.some(pair => pair[0] === word && pair[1] === definition);

            const item1 = selectedWordItem;
            const item2 = selectedDefItem;

            if (isMatch) {
                item1.classList.add('correct');
                item2.classList.add('correct');
                item1.classList.remove('selected');
                item2.classList.remove('selected');
                matchedPairsCount++;
                updateMatchScore();

                if (matchedPairsCount === MATCH_COUNT) {
                    matchScoreSpan.textContent = 'Félicitations ! Vous avez trouvé toutes les paires.';
                    matchNextBtn.classList.remove('hidden');
                }
            } else {
                item1.classList.add('error');
                item2.classList.add('error');
                setTimeout(() => {
                    item1.classList.remove('error', 'selected');
                    item2.classList.remove('error', 'selected');
                }, 1000); 
            }
            
            selectedWordItem = null;
            selectedDefItem = null;
        }

        function updateMatchScore() {
            matchScoreSpan.textContent = `Paires trouvées : ${matchedPairsCount} / ${MATCH_COUNT}`;
        }

        matchNextBtn.addEventListener('click', startMatchGame);

        function generateList() {
            vocabularyList.innerHTML = '';
            vocab.forEach(pair => {
                const li = document.createElement('li');
                li.textContent = `${pair[0]} - ${pair[1]}`;
                vocabularyList.appendChild(li);
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            generateChapterButtons(); 
            hideAlert();
            
            if (Object.keys(ALL_VOCAB_DATA).length > 0) {
                const defaultChapterKey = Object.keys(ALL_VOCAB_DATA)[0];
                const defaultChapter = ALL_VOCAB_DATA[defaultChapterKey];
                if (Object.keys(defaultChapter.subcategories).length === 1) {
                     const defaultSubKey = Object.keys(defaultChapter.subcategories)[0];
                     changeVocabulary(defaultChapterKey, defaultSubKey);
                } 
            }
        });
    </script>
</body>
</html>
